<% if document.holdings.present? %>
  <% document.holdings.libraries.select(&:present?).each do |library| %>
    <table class="table table-sm availability" data-controller="live-lookup" data-live-lookup-url-value="<%= availability_index_path %>">
      <caption class='sr-only'>Status of items at <%= library.name %></caption>
      <thead>
        <tr class='active'>
          <th scope='col' class='col-xs-6'><%= library.name %></th>
          <th scope='col' class='col-xs-6'>Status</th>
        </tr>
      </thead>
      <% if document.respond_to?(:to_marc) && document.bound_with? %>
        <tbody class="bound-with-note">
          <tr>
            <th scope='col'>
              Some records bound together
            </th>
          </tr>
          <tr>
            <td colspan='2'>
              <%= link_to('See full record for details', solr_document_path(document)) %>
            </td>
          </tr>
        </tbody>
      <% end %>
      <% library.locations.select(&:present_on_index?).each do |location| %>
        <tbody data-long-list data-list-type="location">
        <% location_request_link = LocationRequestLinkComponent.for(document: document, library: library.code, location: location.code, items: location.items) %>
        <tr class="location-info">
          <th scope="col">
            <%= render partial: "catalog/stackmap_link", locals: { document: document, location: location, location_name_class: '' } %>
            <% if location.mhld.present? %>
              <br/>
              <% location.mhld.each do |mhld| %>
                <% if mhld.public_note.present? %>
                  <%= mhld.public_note %>
                <% end %>
              <% end %>
            <% end %>
          </th>
          <td>
            <% if location.mhld.present? %>
              <% location.mhld.each do |mhld| %>
                <% if mhld.latest_received.present? %>
                  <span class='note-highlight'>Latest: <%= mhld.latest_received %></span>
                <% end %>
              <% end %>
            <% end %>
            <%= render location_request_link unless Settings.libraries[library.code]&.suppress_location_request_link %>
          </td>
        </tr>
        <% if Settings.libraries[library.code]&.suppress_items_list_on_results_view %>
          <tr>
            <td colspan='2'><%= link_to('See full record for details', solr_document_path(document)) %></td>
          </tr>
        <% else %>
          <%= render AccessPanels::LocationItemComponent.with_collection(location.items, document:, render_item_level_request_link: !location_request_link.render?, render_item_note: false) %>
        <% end %>
        </tbody>
      <% end %>
    </table>
  <% end %>
<% end %>
