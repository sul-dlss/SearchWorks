pipeline {
  agent any

  environment {
    GH_CREDS = credentials("sul-ci org token (login)")
  }

  stages {
    stage('harvest') {
      steps {
        checkout scm

        sshagent (['sul-devops-team']){
          sh '''#!/bin/bash -l
          export PATH=/ci/home/bin:$PATH
          export HUB_CONFIG=/ci/home/config/hub

          # Load RVM
          rvm use 3.0.3@searchworks --create
          gem install bundler

          bundle install --without production

          # Harvest
          bin/rake proxies:import_lane || exit 1

          # Make a PR
          git checkout -B lane-ezproxy-update
          git add config/ezproxy/lane_proxy_file.txt
          git commit -m "Update Lane Library EZProxy config" &&
          git push https://${GH_CREDS_USR}:${GH_CREDS_PSW}@github.com/sul-dlss/SearchWorks.git lane-ezproxy-update &&
          GITHUB_USER=${GH_CREDS_USR} GITHUB_PASSWORD=${GH_CREDS_PSW} hub pull-request -f -m "Update Lane Library EZProxy config"
          echo 'Done!'
          '''
        }
      }
    }
  }
}
